<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>뉴스 제목 수집</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;max-width:920px;margin:40px auto;padding:0 16px;color:#111}
      h1{font-size:22px;margin-bottom:16px}
      form{display:flex;gap:8px;margin-bottom:16px}
      input[type=text]{flex:1;padding:10px 12px;border:1px solid #ccc;border-radius:8px}
      button{padding:10px 14px;border:0;border-radius:8px;background:#2563eb;color:#fff;cursor:pointer}
      button:disabled{opacity:.6;cursor:not-allowed}
      table{width:100%;border-collapse:collapse;margin-top:12px}
      th,td{border-bottom:1px solid #eee;padding:10px;text-align:left}
      th{background:#f8fafc}
      .title-cell{width:85%;word-wrap:break-word;word-break:break-word}
      .url-cell{width:15%;text-align:center}
      .muted{color:#666;font-size:13px}
      .progress-container{margin:16px 0;padding:12px;background:#f8fafc;border-radius:8px;display:none}
      .progress-bar{width:100%;height:8px;background:#e5e7eb;border-radius:4px;overflow:hidden}
      .progress-fill{height:100%;background:#2563eb;transition:width 0.3s ease;width:0%}
      .progress-text{margin-top:8px;font-size:14px;color:#374151}
      .status{margin:8px 0;padding:8px 12px;border-radius:6px;font-size:14px}
      .status.info{background:#dbeafe;color:#1e40af}
      .status.wait{background:#fef3c7;color:#92400e}
      .status.error{background:#fee2e2;color:#dc2626}
      .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);display:none;z-index:1000}
      .modal-content{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:white;border-radius:12px;width:90%;max-width:500px;max-height:80vh;display:flex;flex-direction:column}
      .modal-header{display:flex;justify-content:space-between;align-items:center;padding:24px 24px 16px 24px;border-bottom:1px solid #e5e7eb;flex-shrink:0}
      .modal-title{font-size:18px;font-weight:600}
      .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#666}
      .keywords-container{flex:1;overflow-y:auto;padding:16px 24px;max-height:calc(80vh - 140px)}
      .keywords-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
      .keyword-item{display:flex;align-items:center;justify-content:space-between;padding:8px 12px;background:#f8fafc;border-radius:8px;border:1px solid #e5e7eb}
      .keyword-text{font-size:14px;color:#374151;flex:1}
      .toggle-switch{position:relative;width:44px;height:24px;background:#ccc;border-radius:12px;cursor:pointer;transition:background 0.3s}
      .toggle-switch.active{background:#2563eb}
      .toggle-switch::after{content:'';position:absolute;top:2px;left:2px;width:20px;height:20px;background:white;border-radius:50%;transition:transform 0.3s}
      .toggle-switch.active::after{transform:translateX(20px)}
      .add-keyword{display:flex;gap:8px;padding:16px 24px;border-top:1px solid #e5e7eb;flex-shrink:0}
      .add-keyword input{flex:1;padding:8px 12px;border:1px solid #ccc;border-radius:6px}
      .add-keyword button{padding:8px 16px;background:#2563eb;color:white;border:none;border-radius:6px;cursor:pointer}
    </style>
  </head>
  <body>
    <h1>네이버 뉴스 제목 수집</h1>
    <form id="f">
      <input id="q" type="text" placeholder="검색어를 입력하세요 (예: 2일)" />
      <button id="go" type="submit">검색</button>
      <button id="cancel" type="button" style="display:none; background:#dc2626;">취소</button>
    </form>
    <div class="muted">최대 30건까지 표시됩니다.</div>
    <button id="exclude-keywords-btn" type="button" style="margin-top:8px; padding:6px 12px; border:1px solid #ccc; border-radius:6px; background:#f8fafc; cursor:pointer; font-size:14px; color:#333;">제외 키워드 관리</button>
    <button id="exclude-suffixes-btn" type="button" style="margin-top:8px; margin-left:8px; padding:6px 12px; border:1px solid #ccc; border-radius:6px; background:#f8fafc; cursor:pointer; font-size:14px; color:#333;">제외 접미사 관리</button>
    
    <div id="progress" class="progress-container">
      <div class="progress-bar">
        <div id="progress-fill" class="progress-fill"></div>
      </div>
      <div id="progress-text" class="progress-text">준비 중...</div>
    </div>
    
    <div id="status"></div>
    
    <!-- 제외 키워드 관리 모달 -->
    <div id="keywords-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">제외 키워드 관리</h3>
          <button class="close-btn" id="close-modal">&times;</button>
        </div>
        <div class="help-text" style="padding: 12px 24px; background: #f8fafc; border-bottom: 1px solid #e5e7eb; color: #6b7280; font-size: 14px;">
          <span style="margin-right: 6px;">ℹ️</span>검색결과에 제외하고 싶은 키워드 추가
        </div>
        <div class="keywords-container">
          <div class="keywords-grid" id="keywords-list"></div>
        </div>
        <div class="add-keyword">
          <input type="text" id="new-keyword" placeholder="새 키워드 입력" />
          <button id="add-keyword-btn">추가</button>
        </div>
      </div>
    </div>
    
    <!-- 제외 접미사 관리 모달 -->
    <div id="suffixes-modal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h3 class="modal-title">제외 접미사 관리</h3>
          <button class="close-btn" id="close-suffixes-modal">&times;</button>
        </div>
        <div class="help-text" style="padding: 12px 24px; background: #f8fafc; border-bottom: 1px solid #e5e7eb; color: #6b7280; font-size: 14px;">
          <span style="margin-right: 6px;">ℹ️</span>검색어 바로 뒤에 붙는 접미사 중 제외시키고 싶은 키워드 추가
        </div>
        <div class="keywords-container">
          <div class="keywords-grid" id="suffixes-list"></div>
        </div>
        <div class="add-keyword">
          <input type="text" id="new-suffix" placeholder="새 접미사 입력" />
          <button id="add-suffix-btn">추가</button>
        </div>
      </div>
    </div>
    
    <table id="tbl" hidden>
      <thead><tr><th class="title-cell">제목</th><th class="url-cell">링크</th></tr></thead>
      <tbody></tbody>
    </table>
    <script>
      const form = document.getElementById('f');
      const q = document.getElementById('q');
      const tbl = document.getElementById('tbl');
      const tbody = tbl.querySelector('tbody');
      const progress = document.getElementById('progress');
      const progressFill = document.getElementById('progress-fill');
      const progressText = document.getElementById('progress-text');
      const status = document.getElementById('status');
      const cancelBtn = document.getElementById('cancel');
      let currentReader = null;
      
      // 제외 키워드 관리
      const excludeKeywordsBtn = document.getElementById('exclude-keywords-btn');
      const keywordsModal = document.getElementById('keywords-modal');
      const closeModal = document.getElementById('close-modal');
      const keywordsList = document.getElementById('keywords-list');
      const newKeywordInput = document.getElementById('new-keyword');
      const addKeywordBtn = document.getElementById('add-keyword-btn');
      
      // 기본 제외 키워드 (newsScrp.py에서 가져온 것)
      const defaultExcludeKeywords = [
        "1박2일", "전통시장", "설명회", "야구", "승진", "사과문", "채용", "날씨", "결혼", "합격자",
        "시상식", "청약", "대회", "축제", "당선작", "박람회", "수상자", "페스티벌", "마라톤", "캠페인",
        "귀농", "귀촌", "패션쇼", "미술제", "결방", "문화제", "[포토]", "음악극", "클래식"
      ];
      
      // 기본 제외 접미사 (newsScrp.py에서 가져온 것)
      const defaultExcludeSuffixes = ["간", "동안", "만", "간의", "만의", "만에"];
      
      // localStorage에서 제외 키워드 로드, 없으면 기본값 사용
      let excludeKeywords = loadExcludeKeywords();
      let keywordStates = loadKeywordStates();
      let excludeSuffixes = loadExcludeSuffixes();
      let suffixStates = loadSuffixStates();
      
      function showStatus(message, type = 'info') {
        status.innerHTML = `<div class="status ${type}">${message}</div>`;
      }
      
      function updateProgress(current, total, message) {
        const percent = Math.round((current / total) * 100);
        progressFill.style.width = percent + '%';
        progressText.textContent = `${current}/${total} (${percent}%) - ${message}`;
      }
      
      function resetUI() {
        form.querySelector('button').disabled = false;
        cancelBtn.style.display = 'none';
        currentReader = null;
        progress.style.display = 'none';
        progressFill.style.width = '0%';
        progressText.textContent = '준비 중...';
      }
      
      function renderKeywords() {
        keywordsList.innerHTML = '';
        excludeKeywords.forEach((keyword, index) => {
          const item = document.createElement('div');
          item.className = 'keyword-item';
          const isActive = keywordStates[keyword] !== false; // 기본값은 true (ON)
          item.innerHTML = `
            <span class="keyword-text">${keyword}</span>
            <div class="toggle-switch ${isActive ? 'active' : ''}" onclick="toggleKeyword('${keyword}')"></div>
          `;
          keywordsList.appendChild(item);
        });
      }
      
      function renderSuffixes() {
        const suffixesList = document.getElementById('suffixes-list');
        suffixesList.innerHTML = '';
        excludeSuffixes.forEach((suffix, index) => {
          const item = document.createElement('div');
          item.className = 'keyword-item';
          const isActive = suffixStates[suffix] !== false; // 기본값은 true (ON)
          item.innerHTML = `
            <span class="keyword-text">${suffix}</span>
            <div class="toggle-switch ${isActive ? 'active' : ''}" onclick="toggleSuffix('${suffix}')"></div>
          `;
          suffixesList.appendChild(item);
        });
      }
      
      function toggleKeyword(keyword) {
        keywordStates[keyword] = !keywordStates[keyword];
        renderKeywords();
        saveKeywordStates();
      }
      
      function toggleSuffix(suffix) {
        suffixStates[suffix] = !suffixStates[suffix];
        renderSuffixes();
        saveSuffixStates();
      }
      
      function loadExcludeKeywords() {
        try {
          const saved = localStorage.getItem('excludeKeywords');
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (e) {
          console.error('제외 키워드 로드 실패:', e);
        }
        return [...defaultExcludeKeywords];
      }
      
      function saveExcludeKeywords() {
        try {
          localStorage.setItem('excludeKeywords', JSON.stringify(excludeKeywords));
        } catch (e) {
          console.error('제외 키워드 저장 실패:', e);
        }
      }
      
      function loadKeywordStates() {
        try {
          const saved = localStorage.getItem('keywordStates');
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (e) {
          console.error('키워드 상태 로드 실패:', e);
        }
        return {};
      }
      
      function saveKeywordStates() {
        try {
          localStorage.setItem('keywordStates', JSON.stringify(keywordStates));
        } catch (e) {
          console.error('키워드 상태 저장 실패:', e);
        }
      }
      
      function loadExcludeSuffixes() {
        try {
          const saved = localStorage.getItem('excludeSuffixes');
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (e) {
          console.error('제외 접미사 로드 실패:', e);
        }
        return [...defaultExcludeSuffixes]; // Return a copy of defaults
      }
      
      function saveExcludeSuffixes() {
        try {
          localStorage.setItem('excludeSuffixes', JSON.stringify(excludeSuffixes));
        } catch (e) {
          console.error('제외 접미사 저장 실패:', e);
        }
      }
      
      function loadSuffixStates() {
        try {
          const saved = localStorage.getItem('suffixStates');
          if (saved) {
            return JSON.parse(saved);
          }
        } catch (e) {
          console.error('접미사 상태 로드 실패:', e);
        }
        return {};
      }
      
      function saveSuffixStates() {
        try {
          localStorage.setItem('suffixStates', JSON.stringify(suffixStates));
        } catch (e) {
          console.error('접미사 상태 저장 실패:', e);
        }
      }
      
      function addKeyword() {
        const keyword = newKeywordInput.value.trim();
        if (keyword && !excludeKeywords.includes(keyword)) {
          excludeKeywords.push(keyword);
          keywordStates[keyword] = true; // 새로 추가된 키워드는 기본적으로 ON
          newKeywordInput.value = '';
          renderKeywords();
          saveExcludeKeywords();
          saveKeywordStates();
        }
      }
      
      function addSuffix() {
        const newSuffixInput = document.getElementById('new-suffix');
        const suffix = newSuffixInput.value.trim();
        if (suffix && !excludeSuffixes.includes(suffix)) {
          excludeSuffixes.push(suffix);
          suffixStates[suffix] = true; // 새로 추가된 접미사는 기본적으로 ON
          newSuffixInput.value = '';
          renderSuffixes();
          saveExcludeSuffixes();
          saveSuffixStates();
        }
      }
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const query = q.value.trim();
        if (!query) return;
        
        form.querySelector('button').disabled = true;
        cancelBtn.style.display = 'inline-block';
        tbody.innerHTML = '';
        tbl.hidden = true;
        progress.style.display = 'block';
        status.innerHTML = '';
        
        try {
          // 활성화된 키워드만 필터링
          const activeKeywords = excludeKeywords.filter(keyword => keywordStates[keyword] !== false);
          const excludeKeywordsParam = activeKeywords.join(',');
          
          // 활성화된 접미사만 필터링
          const activeSuffixes = excludeSuffixes.filter(suffix => suffixStates[suffix] !== false);
          const excludeSuffixesParam = activeSuffixes.join(',');
          
          const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=30&exclude_keywords=${encodeURIComponent(excludeKeywordsParam)}&exclude_suffixes=${encodeURIComponent(excludeSuffixesParam)}`);
          const reader = res.body.getReader();
          currentReader = reader;
          const decoder = new TextDecoder();
          
          while (true) {
            const { done, value } = await reader.read();
            if (done) break;
            
            const chunk = decoder.decode(value);
            const lines = chunk.split('\n');
            
            for (const line of lines) {
              if (line.startsWith('data: ')) {
                try {
                  const data = JSON.parse(line.slice(6));
                  
                  switch (data.type) {
                    case 'start':
                      showStatus(`검색 시작: "${data.query}" (최대 ${data.limit}건)`, 'info');
                      updateProgress(0, data.limit, '검색 시작');
                      break;
                      
                    case 'progress':
                      updateProgress(data.current, data.total, data.message);
                      break;
                      
                    case 'wait':
                      showStatus(data.message, 'wait');
                      break;
                      
                    case 'error':
                      showStatus(data.message, 'error');
                      break;
                      
                    case 'item':
                      // 새 항목을 테이블에 즉시 추가
                      const tr = document.createElement('tr');
                      const td1 = document.createElement('td');
                      const td2 = document.createElement('td');
                      td1.className = 'title-cell';
                      td2.className = 'url-cell';
                      td1.textContent = data.item.title || '';
                      if (data.item.url) {
                        const a = document.createElement('a');
                        a.href = data.item.url;
                        a.textContent = '기사원문';
                        a.target = '_blank';
                        a.style.color = '#2563eb';
                        a.style.textDecoration = 'none';
                        a.style.fontSize = '14px';
                        td2.appendChild(a);
                      } else {
                        td2.textContent = '';
                      }
                      tr.appendChild(td1); tr.appendChild(td2);
                      tbody.appendChild(tr);
                      tbl.hidden = false;
                      break;
                      
                    case 'page_complete':
                      showStatus(`페이지 ${data.page} 완료: ${data.found}건 발견, 총 ${data.total}건`, 'info');
                      break;
                      
                    case 'complete':
                      showStatus(`검색 완료! 총 ${data.total}건 수집`, 'info');
                      updateProgress(data.total, data.total, '완료');
                      break;
                  }
                } catch (e) {
                  console.error('JSON 파싱 오류:', e, line);
                }
              }
            }
          }
        } catch (e) {
          if (e.name === 'AbortError') {
            showStatus('검색이 취소되었습니다.', 'info');
          } else {
            showStatus('요청 실패: ' + (e?.message || e), 'error');
          }
        } finally {
          resetUI();
        }
      });
      
      // 취소 버튼 이벤트 리스너
      cancelBtn.addEventListener('click', () => {
        if (currentReader) {
          currentReader.cancel();
          showStatus('검색이 취소되었습니다.', 'info');
          // 즉시 UI 초기화
          setTimeout(() => {
            resetUI();
          }, 100);
        }
      });
      
      // 제외 키워드 관리 이벤트 리스너
      excludeKeywordsBtn.addEventListener('click', () => {
        renderKeywords();
        keywordsModal.style.display = 'block';
      });
      
      closeModal.addEventListener('click', () => {
        keywordsModal.style.display = 'none';
      });
      
      keywordsModal.addEventListener('click', (e) => {
        if (e.target === keywordsModal) {
          keywordsModal.style.display = 'none';
        }
      });
      
      addKeywordBtn.addEventListener('click', addKeyword);
      
      newKeywordInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addKeyword();
        }
      });
      
      // 제외 접미사 관리 이벤트 리스너
      const excludeSuffixesBtn = document.getElementById('exclude-suffixes-btn');
      const suffixesModal = document.getElementById('suffixes-modal');
      const closeSuffixesModal = document.getElementById('close-suffixes-modal');
      const addSuffixBtn = document.getElementById('add-suffix-btn');
      const newSuffixInput = document.getElementById('new-suffix');
      
      excludeSuffixesBtn.addEventListener('click', () => {
        renderSuffixes();
        suffixesModal.style.display = 'block';
      });
      
      closeSuffixesModal.addEventListener('click', () => {
        suffixesModal.style.display = 'none';
      });
      
      suffixesModal.addEventListener('click', (e) => {
        if (e.target === suffixesModal) {
          suffixesModal.style.display = 'none';
        }
      });
      
      addSuffixBtn.addEventListener('click', addSuffix);
      
      newSuffixInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addSuffix();
        }
      });
      
      // 페이지 로드 시 키워드 및 접미사 목록 초기화
      renderKeywords();
      renderSuffixes();
    </script>
  </body>
  </html>


